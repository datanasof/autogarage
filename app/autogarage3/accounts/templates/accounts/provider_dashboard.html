
{% extends 'base.html' %}
{% block content %}
<div class="container">
  <h2>Provider Portal</h2>
  <p>
    <a class="btn" href="/edit/provider/">Edit my company &amp; contact details</a>
  </p>
  <h3>Event calendar (week)</h3>
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/main.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.js'></script>
  <div id='calendar'></div>
  <h3 style="margin-top:1rem;">Nearby providers (50km)</h3>
  <div id="prov-map" class="map"></div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function(){ const cal=new FullCalendar.Calendar(document.getElementById('calendar'),{ initialView:'timeGridWeek', events:{ url:'/api/appointments/provider-calendar/' } }); cal.render(); });
  async function loadProvidersOnMap(map){ const res=await fetch('/api/providers/'); const data=await res.json(); navigator.geolocation?.getCurrentPosition(pos=>{ const me={lat:pos.coords.latitude,lng:pos.coords.longitude}; new google.maps.Marker({position:me,map,label:'Me'}); data.forEach(p=>{ if(p.latitude&&p.longitude){ const lat=parseFloat(p.latitude),lng=parseFloat(p.longitude); if(haversine(me.lat,me.lng,lat,lng)<=50){ new google.maps.Marker({position:{lat,lng},map,title:p.company_name}); } } }) }); }
  function haversine(lat1,lon1,lat2,lon2){ const R=6371; const dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(a)); }
  function initProvMap(){ const c={lat:42.6977,lng:23.3219}; const map=new google.maps.Map(document.getElementById('prov-map'),{center:c,zoom:9}); loadProvidersOnMap(map); }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initProvMap"></script>
{% endblock %}
